<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      color: #333;
      margin: 10px 0;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .draggable {
      width: 100px;
      height: 100px;
      background: #e0e0e0;
      border: 1px solid #333;
      border-radius: 8px;
      text-align: center;
      line-height: 100px;
      cursor: move;
      touch-action: none;
      user-select: none;
    }
    .drop-zone {
      width: 100%;
      min-height: 200px;
      border: 2px dashed #666;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      padding: 15px;
      box-sizing: border-box;
      font-size: 16px;
      color: #333;
    }
    .drop-zone img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-top: 10px;
    }
    .feedback {
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
      color: #333;
    }
    .feedback.success {
      color: #28a745;
    }
    .feedback.error {
      color: #dc3545;
    }
    .latex-display {
      margin: 20px auto;
      max-width: 800px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: center;
    }
    .latex-code {
      font-family: monospace;
      font-size: 14px;
      margin: 10px 0;
    }
    .explain-button {
      display: none;
      margin: 10px auto;
      padding: 10px 20px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .explain-button:hover {
      background: #0056b3;
    }
    @media (min-width: 768px) {
      h1 {
        font-size: 32px;
      }
      .container {
        flex-direction: row;
        justify-content: center;
      }
      .draggable {
        width: 120px;
        height: 120px;
        line-height: 120px;
      }
      .drop-zone {
        width: 600px;
        min-height: 400px;
        font-size: 18px;
      }
      .latex-display {
        font-size: 16px;
      }
    }
    @media (min-width: 1024px) {
      .drop-zone {
        width: 800px;
        min-height: 500px;
      }
    }
  </style>
</head>
<body>
  <h1>Math Assistant</h1>
  <div class="container">
    <div class="draggable" id="draggable">Drag Me</div>
    <div class="drop-zone" id="dropZone">Drop Here or Use Camera</div>
    <input type="file" accept="image/*" id="cameraInput" style="display: none;">
  </div>
  <div class="feedback" id="feedback"></div>
  <div class="latex-display" id="latexDisplay" style="display: none;">
    <h2>LaTeX Output</h2>
    <div class="latex-code" id="latexCode"></div>
    <div class="latex-rendered" id="latexRendered"></div>
    <button class="explain-button" id="explainButton">Explain Formula with Grok</button>
  </div>

  <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://unpkg.com/interactjs@1.10.27/dist/interact.min.js"></script>
  <script>
    // Placeholder drag-and-drop with Interact.js
    interact('.draggable')
      .draggable({
        listeners: {
          move: function(event) {
            const target = event.target;
            const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
            const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
            target.style.transform = `translate(${x}px, ${y}px)`;
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
          }
        }
      });

    const dropZone = document.getElementById('dropZone');
    const cameraInput = document.getElementById('cameraInput');
    const feedback = document.getElementById('feedback');
    const latexDisplay = document.getElementById('latexDisplay');
    const latexCode = document.getElementById('latexCode');
    const latexRendered = document.getElementById('latexRendered');
    const explainButton = document.getElementById('explainButton');
    const originalDropZoneText = dropZone.textContent;

    // Handle mobile tap to trigger camera
    let isProcessing = false;
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    if (isMobile) {
      dropZone.addEventListener('touchstart', function(event) {
        if (isProcessing) return;
        isProcessing = true;
        event.preventDefault();
        cameraInput.click();
        setTimeout(() => { isProcessing = false; }, 1000);
      });
      dropZone.addEventListener('click', function(event) {
        if (isProcessing) return;
        isProcessing = true;
        event.preventDefault();
        cameraInput.click();
        setTimeout(() => { isProcessing = false; }, 1000);
      });
    }

    // Handle desktop drop zone
    interact('.drop-zone').dropzone({
      accept: '.draggable',
      ondrop: function(event) {
        if (!isMobile) {
          dropZone.innerHTML = '';
          dropZone.appendChild(event.relatedTarget);
          dropZone.textContent = '';
        }
      }
    });

    // Handle file input (camera or file drop)
    dropZone.addEventListener('dragover', (e) => e.preventDefault());
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      if (e.dataTransfer.files.length) {
        handleFiles(e.dataTransfer.files);
      }
    });
    cameraInput.addEventListener('change', function(e) {
      if (e.target.files.length) {
        handleFiles(e.dataTransfer.files);
      }
    });

    function handleFiles(files) {
      const file = files[0];
      // Clear drop zone and add new image
      dropZone.innerHTML = '';
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.maxWidth = '100%';
      dropZone.appendChild(img);

      // Show sending feedback
      feedback.textContent = 'Sending image...';
      feedback.className = 'feedback';

      // Send image to FastAPI server
      const formData = new FormData();
      formData.append('image', file);
      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error('Server not responding');
        return response.json();
      })
      .then(data => {
        feedback.textContent = 'Image sent successfully!';
        feedback.className = 'feedback success';
        const latex = data.latex || 'E = mc^2';
        latexCode.textContent = latex;
        latexRendered.innerHTML = `\\(${latex}\\)`; // MathJax will render this
        latexDisplay.style.display = 'block';
        explainButton.style.display = 'block';
        MathJax.typeset();
      })
      .catch(error => {
        feedback.textContent = 'Failed to connect to server';
        feedback.className = 'feedback error';
        console.error('Error sending image:', error);
        // Fallback LaTeX
        const sampleLatex = 'E = mc^2';
        latexCode.textContent = sampleLatex;
        latexRendered.innerHTML = `\\(${sampleLatex}\\)`; // MathJax will render this
        latexDisplay.style.display = 'block';
        explainButton.style.display = 'block';
        MathJax.typeset();
      });
    }

    // Placeholder for Grok API call
    explainButton.addEventListener('click', function() {
      const latex = latexCode.textContent;
      const query = `Explain this formula: ${latex}`;
      alert('This would send to Grok API: ' + query);
    });
  </script>
</body>
</html>
